<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>MathPro</title>
<style>
body{margin:0;padding:20px;font-family:system-ui,sans-serif;background:#f6f8fb}
.container{max-width:500px;margin:0 auto;background:#fff;border-radius:16px;padding:24px;box-shadow:0 12px 24px rgba(15,23,42,.08)}
h2{margin:0 0 12px;font-size:1.2rem}
.status{color:#888;font-size:14px}
</style>
</head>
<body>
<div class="container">
  <h2>MathPro - Handwriting Renderer</h2>
  <p class="status">Waiting for content...</p>
  <div id="output"></div>
</div>

<script type="module">
let rpcId = 0;
const pendingRequests = new Map();

const rpcNotify = (method, params) => {
  window.parent.postMessage({ jsonrpc: "2.0", method, params }, "*");
};

const rpcRequest = (method, params) =>
  new Promise((resolve, reject) => {
    const id = ++rpcId;
    pendingRequests.set(id, { resolve, reject });
    window.parent.postMessage({ jsonrpc: "2.0", id, method, params }, "*");
  });

window.addEventListener("message", (event) => {
  if (event.source !== window.parent) return;
  const msg = event.data;
  if (!msg || msg.jsonrpc !== "2.0") return;

  if (typeof msg.id === "number") {
    const pending = pendingRequests.get(msg.id);
    if (!pending) return;
    pendingRequests.delete(msg.id);
    if (msg.error) { pending.reject(msg.error); return; }
    pending.resolve(msg.result);
    return;
  }

  if (msg.method === "ui/notifications/tool-result") {
    const content = msg.params?.structuredContent?.content;
    if (content) renderHandwriting(content);
  }
}, { passive: true });

async function initBridge() {
  try {
    await rpcRequest("ui/initialize", {
      appInfo: { name: "mathpro-widget", version: "1.0.0" },
      appCapabilities: {},
      protocolVersion: "2026-01-26",
    });
    rpcNotify("ui/notifications/initialized", {});
  } catch (e) {
    console.error("Bridge init failed:", e);
  }
}
initBridge();

function renderHandwriting(content) {
  const status = document.querySelector('.status');
  const output = document.getElementById('output');
  status.textContent = 'Rendering...';
  output.innerHTML = '<p style="font-family:cursive;font-size:18px;line-height:1.8;padding:16px;background:#fffef5;border-radius:8px;border:1px solid #e0dcc8">'
    + content.replace(/\n/g, '<br>')
    + '</p>';
  status.textContent = 'Rendered! (placeholder - full engine coming soon)';
}
</script>
</body>
</html>
